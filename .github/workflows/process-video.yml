name: Process Video Job

on:
  repository_dispatch:
    types: [new_video_job]

jobs:
  ffmpeg-job:
    runs-on: ubuntu-latest
    container:
      image: jrottenberg/ffmpeg:6.0-ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          apt-get update -qq
          apt-get install -y curl jq

      - name: FFmpeg version
        run: ffmpeg -version

      # -----------------------------
      # Download video / intro / audio
      # -----------------------------
      - name: Download input files
        run: |
          echo "‚¨á Download main video..."
          curl -s -L -o input.mp4 "${{ secrets.MY_DOWNLOAD_URL }}?id=${{ github.event.client_payload.video_url }}&raw=1"

          INTRO_URL="${{ github.event.client_payload.intro_url }}"
          if [ ! -z "$INTRO_URL" ] && [ "$INTRO_URL" != "0" ]; then
            echo "‚¨á Download intro..."
            curl -s -L -o intro.mp4 "${{ secrets.MY_INTRO_URL }}?id=$INTRO_URL"
          else
            echo "No intro"
          fi

          AUDIO_URL="${{ github.event.client_payload.audio_url }}"
          if [ ! -z "$AUDIO_URL" ] && [ "$AUDIO_URL" != "0" ]; then
            echo "‚¨á Download audio mp3..."
            curl -s -L -o audio.mp3 "$AUDIO_URL"
          else
            echo "No audio"
          fi

      # -----------------------------
      # Run FFmpeg
      # -----------------------------
      - name: Process video
        run: |
          chmod +x process_video.sh

          INTRO_FILE=""
          [ -s intro.mp4 ] && INTRO_FILE="intro.mp4"

          AUDIO_FILE=""
          [ -s audio.mp3 ] && AUDIO_FILE="audio.mp3"

          ./process_video.sh \
            input.mp4 \
            "$INTRO_FILE" \
            "${{ github.event.client_payload.flip }}" \
            "$AUDIO_FILE" \
            output_final.mp4

      # -----------------------------
      # Upload + callback
      # -----------------------------
      - name: Upload & callback
        run: |
          echo "‚¨Ü Uploading..."
          response=$(curl -s -w "%{http_code}" -o upload_response.json \
            -F "file=@output_final.mp4" \
            "${{ secrets.UPLOAD_URL }}")

          code=$(printf "%s" "$response" | tail -c 3)
          body=$(cat upload_response.json)

          if [ "$code" != "200" ]; then
            echo "‚ùå Upload failed ($code)"
            cat upload_response.json
            exit 1
          fi

          output_url=$(echo "$body" | jq -r '.output_url')
          if [ -z "$output_url" ] || [ "$output_url" = "null" ]; then
            echo "‚ùå No output_url"
            exit 1
          fi

          echo "::add-mask::$output_url"
          echo "‚úÖ Upload OK"

          echo "üì° Callback..."
          curl -s -X POST -H "Content-Type: application/json" \
            -d '{"job_id":"${{ github.event.client_payload.job_id }}","output_url":"'"$output_url"'"}' \
            "${{ secrets.CALLBACK_URL }}"
